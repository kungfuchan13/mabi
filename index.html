<html onkeydown="addKey(event);" onkeyup="removeKey(event);">
<div id="mtrnm" style="width: 100px; height: 100px; background-color: rgb(0, 0, 0);"></div>
BPM: <input id="tempoIn" value="120"><br>
Sensitivity: <input id="sens" value="1"><br>
<input type="button" value="Reset" onclick="resetMetronome();"><br>
<br>
<div style="border: 5px solid purple; padding: 10px;">
	A: <input id="65" value="c" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="setKeyAndFreq(this);">
	S: <input id="83" value="d" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	D: <input id="68" value="e" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	F: <input id="70" value="f" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	G: <input id="71" value="g" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	H: <input id="72" value="a" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	J: <input id="74" value="b" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	K: <input id="75" value=">c<" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	L: <input id="76" value=">d<" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	;: <input id="186" value=">e<" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	': <input id="222" value=">f<" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;"><br>&nbsp;&nbsp;&nbsp;&nbsp;
	Z: <input id="90" value="c" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	X: <input id="88" value="d" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	C: <input id="67" value="e" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	V: <input id="86" value="f" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	B: <input id="66" value="g" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	N: <input id="78" value="a" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	M: <input id="77" value="b" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	,: <input id="188" value=">c<" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	.: <input id="190" value=">d<" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
	/: <input id="191" value=">e<" style="width: 25px; text-align: center;" onfocus="recording = false;" onblur="keys[this.id] = this.value; recording = true;">
</div>
<br>
<br>
<br>
<br>
<textarea id="songarea" style="width: 500px; height: 400px;" onfocus="recording = false;" onblur="recording = true;"></textarea>
</html>



<script>
var fps = 10;
var loop = setInterval(update, fps);

var tempoIn = document.getElementById("tempoIn");
var sens = document.getElementById("sens");
var tempo = 120;
var beat = 50
var interval = 200;
var sensitivity = 1;

var noteLength = 0;
var tick = 0;
var mtrnm = document.getElementById("mtrnm");

var activeKeys = {};
var activeKey = false;

var songarea = document.getElementById("songarea");
var song = "";
var recording = true;

var audioContext = new AudioContext();
var oscillator = audioContext.createOscillator();
oscillator.connect(audioContext.destination);

var keys = { '65' : 'c', '83' : 'd', '68' : 'e', '70' : 'f', '71' : 'g', '72' : 'a', '74' : 'b', '75' : '>c<', '76' : '>d<', '186' : '>e<', '222' : '>f<',
		'90' : 'c', '88' : 'd', '67' : 'e', '86' : 'f', '66' : 'g', '78' : 'a', '77' : 'b', '188' : '>c<', '190' : '>d<', '191' : '>e<' };

const BASE_FREQS = { 'c' : 261.63, 'c+' : 277.18, 'd-' : 277.18, 'd' : 293.66, 'd+' : 311.13, 'e-' : 311.13, 'e' : 329.63, 'f' : 349.23, 'f+' : 369.99, 'g-' : 369.99, 'g' : 392, 'g+' : 415.3, 'a-' : 415.3, 'a' : 440, 'a+' : 466.16, 'b-' : 466.16, 'b' : 493.88 };

var freq = { '65' : 261.63, '83' : 299.66, '68' : 329.63, '70' : 349.23, '71' : 392, '72' : 440, '74' : 493.88, '75' : 523.25, '76' : 587.33, '186' : 659.25, '222' : 698.46,
		'90' : 261.63, '88' : 299.66, '67' : 329.63, '86' : 349.23, '66' : 392, '78' : 440, '77' : 493.88, '188' : 523.23, '190' : 587.33, '191' : 659.25 };

function update() {
	if (tick < beat)
		tick++;
	else {
		tick = 0;
	}
	metronome(tick/beat);
	setTempo();
	noteLength++;
	displaySong();
}

function setTempo() {
	tempo = parseInt(tempoIn.value);
	beat = 60*1000/tempo/fps;
	sensitivity = parseInt(sens.value);
	interval = beat*(4/sensitivity);
}

function addNote() {
	var repeatCount = Math.floor(noteLength/(interval*1.5));
	var remainder = noteLength - interval*1.5*repeatCount;
	var baseNote = "";
	var shift = "";
	var back = "";
	for (i = 0; i < activeKey.length; i++) {
		if (activeKey[i] == ">")
			shift += activeKey[i];
		else if (activeKey[i] == "<")
			back += activeKey[i];
		else
			baseNote += activeKey[i];
	}
	song += shift;
	for (i = 0; i < repeatCount; i++) {
		if (i > 0)
			song += "&";
		song += baseNote + ".";
	}
	if (repeatCount > 0)
		song += "&";
	song += baseNote + calcTime(remainder/interval) + back;
	noteLength = 0;
}

function addRest() {
	repeatCount = Math.floor(noteLength/(interval*1.5));
	remainder = noteLength - interval*1.5*repeatCount;
	for (i = 0; i < repeatCount; i++) {
		song += "r.";
	}
	song += "r" + calcTime(remainder/interval);
	noteLength = 0;
}



function displaySong() {
	songarea.value = "t" + tempo + "l" + Math.max(Math.min(Math.round(beat/(interval/4)), 64), 1) + song;
}

function metronome(rate) {
	red = Math.floor(255 * rate);
	green = 0;
	blue = Math.floor(255 * rate);
	mtrnm.style.backgroundColor = "rgb(" + red + ", " + green + ", " + blue + ")";
}

function resetMetronome() {
	tick = 0;
	noteLength = 0;
	song = "";
}



function calcTime(time) {
	output = Math.round(Math.max(Math.min(1/time, 64), sensitivity));
	return output.toString();
}



function addKey(event) {

	if (recording) {
		// JKL; = 74, 75, 76, 186
		if (!activeKey && keys[event.keyCode.toString()])
			addRest();
		if (keys[event.keyCode.toString()]) {
			if (activeKey && activeKey != keys[event.keyCode.toString()])
				addNote();
			activeKey = keys[event.keyCode.toString()];
		}
	}

	if (keys[event.keyCode.toString()]) {
		oscillator.frequency.value = freq[event.keyCode.toString()];
		oscillator.start();
	}
}

function removeKey(event) {
	if (keys[event.keyCode.toString()] == activeKey) {
		oscillator.stop();
		oscillator = audioContext.createOscillator();
		oscillator.connect(audioContext.destination);
	}

	if (recording) {
		if (keys[event.keyCode.toString()] == activeKey) {
			addNote();
			activeKey = false;
		}
	}
}



function setKeyAndFreq(elem) {
	id = elem.id;
	keys[id] = elem.value;

	note = elem.value;

	var baseNote = "";
	var shift = 0;
	var shiftDir = true; //Right Default
	if (note[0] == ">")
		shiftDir = true;
	else if (note[0] == "<")
		shiftDir = false;
	for (i = 0; i < note.length; i++) {
		if (note[i] == ">" && shiftDir)
			shift++;
		else if (note[i] == "<" && !shiftDir)
			shift--;
		else if (note[i] != ">" && note[i] != "<")
			baseNote += note[i];
	}
	//document.getElementById("sens").value = baseNote;
	freq[id] = BASE_FREQS[baseNote] * Math.pow(2, shift);

	recording = true;
}



function endLoop() {
	clearInterval(loop);
}
</script>
